name: CI and Deploy to GitHub Pages

on:
  push:
    branches: 
      - main
      - release
      - dev
      - feature/*
      - fix/*
  pull_request:
    branches: 
      - main
      - release
      - dev

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Run lint
        run: pnpm run lint

      - name: Run type check
        run: pnpm run build -- --noEmit --skipLibCheck

      - name: Get commit message
        run: echo "COMMIT_MESSAGE=$(git log --format=%B -n 1 ${GITHUB_SHA} | tr '\n' '\\n')" >> $GITHUB_ENV

      - name: Get Beijing time
        run: echo "BEIJING_TIME=$(date -d '+8 hours' +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

      - name: Send notification to Feishu
        run: |
          JSON_DATA='{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "CI Pipeline é€šçŸ¥"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "ğŸš€ğŸš€ğŸš€\nğŸ“‚ **åˆ†æ”¯:** ${{ github.ref_name }}\nğŸ‘¤ **æäº¤äºº:** ${{ github.actor }}\nâ° **æ—¶é—´:** ${{ env.BEIJING_TIME }}\nğŸ“ **æäº¤ä¿¡æ¯:** ${{ env.COMMIT_MESSAGE }}\nğŸ”— **æŸ¥çœ‹ Commit:** [ç‚¹å‡»æŸ¥çœ‹](https://github.com/Adamlmh/Graphite/commit/${{ github.sha }})"
                  }
                }
              ]
            }
          }'
          curl -X POST https://open.feishu.cn/open-apis/bot/v2/hook/869938a0-61fd-4712-8ef9-b1032a425963 \
          -H 'Content-Type: application/json' \
          -d "$JSON_DATA"

      - name: Send PR merge notification to Feishu
        if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
        run: |
          JSON_DATA='{
            "msg_type": "interactive",
            "card": {
              "header": {
                "title": {
                  "tag": "plain_text",
                  "content": "PR åˆå¹¶é€šçŸ¥"
                }
              },
              "elements": [
                {
                  "tag": "div",
                  "text": {
                    "tag": "lark_md",
                    "content": "âœ…âœ…âœ…\nğŸ“‚ **åˆ†æ”¯:** ${{ github.event.pull_request.head.ref }}\nğŸ‘¤ **åˆå¹¶è€…:** ${{ github.actor }}\nâ° **æ—¶é—´:** ${{ env.BEIJING_TIME }}\nğŸ“ **PR æ ‡é¢˜:** ${{ github.event.pull_request.title }}\nğŸ”— **æŸ¥çœ‹ PR:** [ç‚¹å‡»æŸ¥çœ‹](${{ github.event.pull_request.html_url }})"
                  }
                }
              ]
            }
          }'
          curl -X POST https://open.feishu.cn/open-apis/bot/v2/hook/869938a0-61fd-4712-8ef9-b1032a425963 \
          -H 'Content-Type: application/json' \
          -d "$JSON_DATA"

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/release'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm run build

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: './dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4